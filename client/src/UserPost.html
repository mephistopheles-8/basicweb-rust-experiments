<script>
    import PostMarkdown from "./PostMarkdown.html";
    import Tags from "./Tags.html";

    export let postId;
    export let title = "";
    export let description = "";
    export let body = "";
    export let url = "";
    export let permissions = 0;
    export let ord = 0;

    export let tags = [];

    const api = "http://localhost:8080/api/v1";

    let postRequest = Promise.resolve(true);
    let saveRequest;

    $: if (postId && !saveRequest) {
        postRequest 
            = fetch(`${api}/posts/${postId}`)
            . then( res => res.json() )
            . then( ([usr,res]) => {
                title = res.title;
                description = res.description;
                body = res.body;
                url = usr.url;
                permissions = usr.permissions;
                ord = usr.ord;
                saveRequest = Promise.resolve(res);
                return res;
            });
    }
    
    function savePost () {
        if( title && description && body) {
            let endpoint 
                = `${api}/posts`
                + (postId ? `/${postId}` : "");

            saveRequest
                = fetch(endpoint,{
                        method : "POST"
                     ,  headers : {
                            "Content-Type" : "application/json"
                       }
                     , credentials: "same-origin"
                     , body : JSON.stringify([{
                           title
                         , description
                         , body
                         , format : 1
                        },{permissions, ord, url}]) 
                 })
                . then(res => res.json())
                . then(([usr,post]) => {
                        if( !postId ) 
                            postId = post.uuid;
                      return fetch(
                        `${api}/posts/${post.uuid}/tags`, {
                            method : "POST"
                         ,  headers : {
                                "Content-Type" : "application/json"
                           }
                         , credentials: "same-origin"
                         , body : JSON.stringify(tags)
                        }).then( res => res.json() )
                          .then( _ => post )
                  });
        }
    }
</script>
<style>
    label {
        display: block;
    }
</style>
{#await postRequest}
<p>...</p>
{:then}
<form>
    <label>Title <input bind:value={title} type="text"></label>
    <label>Description <input bind:value={description} type="text"></label>
    <label>Url <input bind:value={url} type="text"></label>
    <label>Tags:
        <Tags bind:tags />
    </label>
    <label>Body:
        <PostMarkdown bind:body />
    </label>
    <button type="button" on:click={savePost}>Save</button>
    {#if saveRequest}
    {#await saveRequest}
    <p>Saving...</p>
    {:then p}
    <p>Saved: {p.updated}</p>
    {:catch err}
    <p>Error: {err.message}</p>
    {/await}
    {/if}
</form>
{:catch err}
<p>Error: {err.message}</p>
{/await}
